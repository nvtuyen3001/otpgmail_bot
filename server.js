require('dotenv').config();

const express = require('express');
const axios = require('axios');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// API Tokens - ƒê·ªçc t·ª´ bi·∫øn m√¥i tr∆∞·ªùng (.env file)
const KHOTAIKHOAN_TOKEN = process.env.KHOTAIKHOAN_TOKEN;
const KHOTAIKHOAN_BASE_URL = 'https://api.khotaikhoan.vip/api/v1';

const VIOTP_TOKEN = process.env.VIOTP_TOKEN;
const VIOTP_BASE_URL = 'https://api.viotp.com';

const DAILYOTP_API_KEY = process.env.DAILYOTP_API_KEY;
const DAILYOTP_BASE_URL = 'https://dailyotp.com/api';

// Ki·ªÉm tra token c√≥ t·ªìn t·∫°i kh√¥ng
if (!KHOTAIKHOAN_TOKEN || !VIOTP_TOKEN || !DAILYOTP_API_KEY) {
  console.error('‚ùå L·ªói: Thi·∫øu API tokens! Vui l√≤ng t·∫°o file .env v√† th√™m tokens.');
  console.error('üí° Copy file config.example.env th√†nh .env v√† ƒëi·ªÅn token th·∫≠t.');
  process.exit(1);
}

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Route: Thu√™ s·ªë
app.post('/api/request', async (req, res) => {
  try {
    const { serviceId, provider } = req.body;
    
    console.log(`[REQUEST] Provider: ${provider}, ServiceId: ${serviceId}`);

    if (provider === 'dailyotp') {
      // G·ªçi API DailyOTP GET /rent-number
      try {
        const response = await axios.get(`${DAILYOTP_BASE_URL}/rent-number`, {
          params: {
            appBrand: 'Google / Gmail / Youtube',
            countryCode: 'BD',
            serverName: 'Server 5',
            api_key: DAILYOTP_API_KEY
          },
          timeout: 15000
        });

        console.log(`[REQUEST DAILYOTP] Status: ${response.status}`);
        console.log(`[REQUEST DAILYOTP] Response:`, JSON.stringify(response.data));

        if (response.data && response.data.message === 'Success' && response.data.data) {
          res.json({
            success: true,
            requestId: response.data.data.transId,
            phone: response.data.data.phoneNumber,
            price: response.data.data.cost,
            provider: 'dailyotp'
          });
        } else {
          console.error(`[REQUEST DAILYOTP] Error response:`, response.data);
          res.json({
            success: false,
            message: response.data.message || 'Kh√¥ng th·ªÉ thu√™ s·ªë t·ª´ DailyOTP',
            error_details: response.data
          });
        }
      } catch (dailyotpError) {
        console.error(`[REQUEST DAILYOTP] API Error:`, {
          message: dailyotpError.message,
          status: dailyotpError.response?.status,
          data: dailyotpError.response?.data
        });
        res.json({
          success: false,
          message: `DailyOTP API Error: ${dailyotpError.response?.data?.message || dailyotpError.message}`,
          error_type: dailyotpError.code || 'UNKNOWN'
        });
      }
    } else if (provider === 'viotp') {
      // G·ªçi API VIOTP GET /request/getv2
      const response = await axios.get(`${VIOTP_BASE_URL}/request/getv2`, {
        params: {
          token: VIOTP_TOKEN,
          serviceId: parseInt(serviceId) || 3, // 3 = Gmail/Google, 7 = Facebook theo VIOTP
          network: 'VINAPHONE'
        }
      });

      console.log(`[REQUEST VIOTP] Response:`, JSON.stringify(response.data));

      if (response.data && response.data.status_code === 200 && response.data.data) {
        res.json({
          success: true,
          requestId: response.data.data.request_id,
          phone: response.data.data.phone_number,
          price: null,
          provider: 'viotp'
        });
      } else {
        res.json({
          success: false,
          message: response.data.message || 'Kh√¥ng th·ªÉ thu√™ s·ªë t·ª´ VIOTP'
        });
      }
    } else {
      // G·ªçi API KhoTaiKhoan POST /buy
      const response = await axios.post(`${KHOTAIKHOAN_BASE_URL}/buy`, {
        token: KHOTAIKHOAN_TOKEN,
        serviceId: parseInt(serviceId) || 2, // serviceId = 2 l√† Gmail/Google
        carrier: 'all'
      }, {
        headers: {
          'Content-Type': 'application/json'
        }
      });

      console.log(`[REQUEST KHOTAIKHOAN] Response:`, JSON.stringify(response.data));

      if (response.data && response.data.requestId) {
        res.json({
          success: true,
          requestId: response.data.requestId,
          phone: response.data.phoneNum,
          price: response.data.price,
          provider: 'khotaikhoan'
        });
      } else if (response.data && response.data.error) {
        res.json({
          success: false,
          error: response.data.error,
          message: response.data.message || 'Kh√¥ng th·ªÉ thu√™ s·ªë'
        });
      } else {
        res.json({
          success: false,
          message: 'Kh√¥ng th·ªÉ thu√™ s·ªë'
        });
      }
    }
  } catch (error) {
    console.error('[REQUEST] Error:', error.response?.data || error.message);
    res.status(500).json({
      success: false,
      message: 'L·ªói k·∫øt n·ªëi API',
      error: error.response?.data || error.message
    });
  }
});

// Route: L·∫•y s·ªë d∆∞
app.get('/api/balance', async (req, res) => {
  try {
    const balances = {};

    // DailyOTP balance
    try {
      const dailyotpResponse = await axios.get(`${DAILYOTP_BASE_URL}/me`, {
        params: { api_key: DAILYOTP_API_KEY },
        timeout: 10000
      });
      console.log(`[BALANCE] DailyOTP Response:`, JSON.stringify(dailyotpResponse.data));
      
      if (dailyotpResponse.data && dailyotpResponse.data.data) {
        balances.dailyotp = {
          balance: dailyotpResponse.data.data.balance || 0,
          limit: dailyotpResponse.data.data.limit || 0
        };
      } else {
        console.error('[BALANCE] DailyOTP invalid response:', dailyotpResponse.data);
        balances.dailyotp = { balance: 0, error: true };
      }
    } catch (error) {
      console.error('[BALANCE] DailyOTP API Error:', {
        message: error.message,
        status: error.response?.status,
        data: error.response?.data
      });
      balances.dailyotp = { 
        balance: 0, 
        error: true,
        error_message: error.response?.data?.message || error.message
      };
    }

    // VIOTP balance - kh√¥ng c√≥ API endpoint
    balances.viotp = { balance: null, available: false };

    // KhoTaiKhoan balance - th√™m n·∫øu c√≥ API
    balances.khotaikhoan = { balance: null, available: false };

    res.json({
      success: true,
      balances: balances
    });

  } catch (error) {
    console.error('[BALANCE] Error:', error.message);
    res.status(500).json({
      success: false,
      message: 'Kh√¥ng th·ªÉ l·∫•y s·ªë d∆∞'
    });
  }
});

// Route: Ki·ªÉm tra OTP
app.get('/api/check', async (req, res) => {
  try {
    const { requestId, provider } = req.query;
    
    if (!requestId) {
      return res.json({ success: false, message: 'Thi·∫øu requestId' });
    }

    console.log(`[CHECK OTP] Provider: ${provider}, RequestId: ${requestId}`);

    if (provider === 'dailyotp') {
      // G·ªçi API DailyOTP GET /get-messages
      try {
        const response = await axios.get(`${DAILYOTP_BASE_URL}/get-messages`, {
          params: {
            transId: requestId,
            api_key: DAILYOTP_API_KEY
          },
          timeout: 10000
        });

        console.log(`[CHECK OTP DAILYOTP] Status: ${response.status}`);
        console.log(`[CHECK OTP DAILYOTP] Response:`, JSON.stringify(response.data));

        if (response.data && response.data.message === 'Success' && response.data.data) {
          const orderData = response.data.data;
          
          console.log(`[CHECK OTP DAILYOTP] Order Status: ${orderData.orderStatus}`);
          
          // Ki·ªÉm tra orderStatus - API tr·∫£ v·ªÅ "Success" khi c√≥ OTP
          if (orderData.orderStatus === 'Success' && orderData.code) {
            // ƒê√£ nh·∫≠n OTP - API tr·∫£ v·ªÅ s·∫µn code
            console.log(`[CHECK OTP DAILYOTP] ‚úÖ OTP received: ${orderData.code}`);
            res.json({
              success: true,
              otp_code: orderData.code,
              status: 'completed',
              message: orderData.message || null
            });
          } else if (orderData.orderStatus === 'Waiting message' || orderData.orderStatus === 'Pending') {
            // Ch∆∞a c√≥ tin nh·∫Øn
            console.log(`[CHECK OTP DAILYOTP] ‚è≥ Waiting for message...`);
            res.json({
              success: true,
              otp_code: null,
              status: 'pending'
            });
          } else if (orderData.orderStatus === 'Expired' || orderData.orderStatus === 'Cancelled' || orderData.orderStatus === 'Refunded') {
            console.log(`[CHECK OTP DAILYOTP] ‚ùå Order ${orderData.orderStatus}`);
            res.json({
              success: true,
              otp_code: null,
              status: 'expired'
            });
          } else {
            // Tr·∫°ng th√°i kh√°c - log ƒë·ªÉ debug
            console.log(`[CHECK OTP DAILYOTP] ‚ö†Ô∏è Unknown status: ${orderData.orderStatus}`);
            console.log(`[CHECK OTP DAILYOTP] Full data:`, JSON.stringify(orderData));
            res.json({
              success: true,
              otp_code: orderData.code || null,
              status: orderData.code ? 'completed' : 'pending',
              message: orderData.message || null
            });
          }
        } else {
          console.error(`[CHECK OTP DAILYOTP] Invalid response:`, response.data);
          res.json({
            success: false,
            message: response.data.message || 'Kh√¥ng th·ªÉ ki·ªÉm tra OTP'
          });
        }
      } catch (dailyotpError) {
        console.error(`[CHECK OTP DAILYOTP] API Error:`, {
          message: dailyotpError.message,
          status: dailyotpError.response?.status,
          data: dailyotpError.response?.data
        });
        res.json({
          success: false,
          message: `DailyOTP API Error: ${dailyotpError.response?.data?.message || dailyotpError.message}`,
          error_type: dailyotpError.code || 'UNKNOWN'
        });
      }
    } else if (provider === 'viotp') {
      // G·ªçi API VIOTP GET /session/getv2
      const response = await axios.get(`${VIOTP_BASE_URL}/session/getv2`, {
        params: {
          token: VIOTP_TOKEN,
          requestId: requestId
        }
      });

      console.log(`[CHECK OTP VIOTP] Response:`, JSON.stringify(response.data));

      if (response.data && response.data.status_code === 200 && response.data.data) {
        const data = response.data.data;
        
        if (data.Status === 1 && data.Code) {
          // C√≥ OTP
          console.log(`[CHECK OTP VIOTP] ‚úÖ OTP received: ${data.Code}`);
          res.json({
            success: true,
            otp_code: data.Code,
            status: 'completed',
            message: data.SmsContent
          });
        } else if (data.Status === 0) {
          // Ch∆∞a c√≥ OTP
          console.log(`[CHECK OTP VIOTP] ‚è≥ Pending...`);
          res.json({
            success: true,
            otp_code: null,
            status: 'pending'
          });
        } else if (data.Status === 2) {
          // H·∫øt h·∫°n
          console.log(`[CHECK OTP VIOTP] ‚ùå Expired`);
          res.json({
            success: true,
            otp_code: null,
            status: 'expired'
          });
        }
      } else {
        res.json({
          success: false,
          message: response.data.message || 'Kh√¥ng th·ªÉ ki·ªÉm tra OTP'
        });
      }
    } else {
      // G·ªçi API KhoTaiKhoan GET /getcode
      const response = await axios.get(`${KHOTAIKHOAN_BASE_URL}/getcode`, {
        params: {
          requestId: requestId
        }
      });

      console.log(`[CHECK OTP KHOTAIKHOAN] Response:`, JSON.stringify(response.data));

      // Ki·ªÉm tra c√≥ OTP kh√¥ng
      if (response.data && response.data.code && response.data.code !== '') {
        // C√≥ OTP
        console.log(`[CHECK OTP KHOTAIKHOAN] ‚úÖ OTP received: ${response.data.code}`);
        res.json({
          success: true,
          otp_code: response.data.code,
          status: 'completed',
          message: response.data.message,
          phoneNum: response.data.phoneNum
        });
      } else if (response.data && response.data.status === 0) {
        // Ch∆∞a c√≥ OTP
        console.log(`[CHECK OTP KHOTAIKHOAN] ‚è≥ Pending...`);
        res.json({
          success: true,
          otp_code: null,
          status: 'pending',
          phoneNum: response.data.phoneNum
        });
      } else if (response.data && response.data.error === 'refunded') {
        // H·∫øt h·∫°n
        console.log(`[CHECK OTP KHOTAIKHOAN] ‚ùå Expired/Refunded`);
        res.json({
          success: true,
          otp_code: null,
          status: 'expired',
          message: response.data.message
        });
      } else {
        console.log(`[CHECK OTP] ‚ö†Ô∏è Unknown response`);
        res.json({
          success: false,
          message: 'Kh√¥ng th·ªÉ ki·ªÉm tra OTP',
          debug: response.data
        });
      }
    }
  } catch (error) {
    console.error('[CHECK OTP] Error:', error.response?.data || error.message);
    res.status(500).json({
      success: false,
      message: 'L·ªói k·∫øt n·ªëi API'
    });
  }
});

app.listen(PORT, () => {
  console.log(`üöÄ Server ƒëang ch·∫°y t·∫°i http://localhost:${PORT}`);
});

